---
title: "共享内存的使用"
date: 2019-12-15T20:00:03+08:00
lastmod: 2020-03-25T20:00:03+08:00
draft: false
tags: ["share", "memory"]
categories: ["note"]
mathjax: false
---

本文主要介绍共享内存的使用。  
<!--more-->

# 优缺点

## 优点

- 高效  
  可以减少数据拷贝。  
- 可常驻  
  不主动detach的情况下，即使进程结束，共享内存仍在。  
  利用这个特点，把数据存到共享内存，这样即使进程重启或升级也不会对用户造成太大影响。  

## 缺点
不方便扩展，使用不当容易弄乱数据。通常需要配合信号量或者其他同步机制使用。  

# 注意事项
- 内存数据结构添加保留字段  
  这样可以提供一定的扩展性，方便后续添加新的字段。  
- 通过编译器确保内存数据结构总大小不变，旧字段位置不变  
  ```c
  #define CAT_TOKEN_1(t1,t2) t1##t2
  #define CAT_TOKEN(t1,t2) CAT_TOKEN_1(t1,t2)

  #define COMPILE_ASSERT(x)  \
					enum {CAT_TOKEN (comp_assert_at_line_, __LINE__) = 1 / !!(x) };

  #ifndef CHECK_OFFSET
  #define CHECK_OFFSET(type, member, value) \
      extern int offset_of_##member##_in_##type##_is_##value \
      [!!(__builtin_offsetof(type,member)==((size_t)(value))) - 1]
  #endif //CHECK_OFFSET
  
  CHECK_OFFSET( UsrRecord, shSrvId, 126 );
  COMPILE_ASSERT( sizeof(UsrRecord) == 512);
  ```

# 实现方式
## shm
通过 `shmget`, `shmat`, `shmctl` 管理。  
可以通过ipcrm命令手动清共享内存。  

## mmap
通过 `mmap`, `munmap`, `msync` 管理。  
mmap会映射到普通文件，所以不仅进程重启还在，机器重启也还在。  

